<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VVFT - VR視野検査システム</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
        #ui-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            font-family: sans-serif;
            max-width: 300px;
            z-index: 1000;
        }
        .status { margin: 10px 0; }
        button {
            margin: 5px;
            padding: 10px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #45a049; }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        #results {
            margin-top: 15px;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .result-good { color: #4CAF50; }
        .result-bad { color: #f44336; }
        .heatmap {
            display: grid;
            grid-template-columns: repeat(5, 30px);
            gap: 2px;
            margin-top: 10px;
        }
        .heatmap-cell {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            border: 1px solid #666;
        }
    </style>
</head>
<body>
    <a-scene>
        <!-- カメラとコントローラー -->
        <a-entity id="rig" position="0 1.6 0">
            <a-entity id="camera" camera look-controls>
                <!-- 中心固視点(赤い点) - カメラに追随 -->
                <a-sphere id="fixation" position="0 0 -1" radius="0.02" color="#FF0000"></a-sphere>
                
                <!-- 指示テキスト -->
                <a-text id="instruction" 
                    value="右トリガーを押すと検査開始&#10;&#10;緑色に変わった数字があったら右トリガー&#10;何も変わらなかったら左トリガー" 
                    position="0 0.3 -1.5" 
                    align="center" 
                    color="#FFFFFF" 
                    width="1.5"></a-text>
            </a-entity>
            
            <!-- コントローラー(Quest対応) -->
            <a-entity id="rightController" oculus-touch-controls="hand: right"></a-entity>
            <a-entity id="leftController" oculus-touch-controls="hand: left"></a-entity>
        </a-entity>

        <!-- 背景 -->
        <a-sky color="#000000"></a-sky>

        <!-- VR内UIパネル(初期非表示、終了時に中央表示) -->
        <a-entity id="ui-panel-vr" position="0 1.6 -2" visible="false">
            <a-plane width="1.5" height="1.2" color="#222222" opacity="0.9"></a-plane>
            
            <!-- タイトル -->
            <a-text value="検査完了" position="0 0.45 0.01" align="center" color="#FFFFFF" width="2"></a-text>
            
            <!-- 結果表示 -->
            <a-text id="result-summary-vr" value="" position="0 0.25 0.01" align="center" color="#AAAAAA" width="1.8"></a-text>
            <a-text id="result-details-vr" value="" position="0 0.05 0.01" align="center" color="#AAAAAA" width="1.8"></a-text>
            
            <!-- ボタン -->
            <a-box id="resetBtn-vr" position="0 -0.25 0.01" width="1" height="0.25" depth="0.05" 
                   color="#4CAF50" class="clickable">
                <a-text value="もう一度検査" position="0 0 0.03" align="center" color="#FFFFFF" width="2"></a-text>
            </a-box>
            
            <a-text value="PCで結果を確認してください" position="0 -0.5 0.01" align="center" color="#AAAAAA" width="1.5"></a-text>
        </a-entity>

        <!-- 5×5グリッド(1-25) -->
        <a-entity id="gridContainer"></a-entity>
    </a-scene>

    <script>
        // グリッド設定
        const gridSize = 5; // 5×5
        const angleStep = 18; // 各数字間の角度(度)
        const distance = 3; // カメラからの距離(m)
        const stimulusDuration = 1000; // 色変化の持続時間(ms)
        const interStimulusInterval = 2000; // 刺激間隔(ms)
        const targetColor = '#00FF00'; // 緑色（ターゲット色）
        const normalColor = '#FFFFFF'; // 白色（通常色）
        
        // 検査状態
        let testRunning = false;
        let currentTrial = 0;
        let trialSequence = [];
        let results = [];
        let numberEntities = {};
        let waitingForResponse = false;
        let currentTarget = null;
        let trialStartTime = 0;
        
        // 球面座標から直交座標への変換
        function sphericalToCartesian(horizontal, vertical, r) {
            const h = horizontal * Math.PI / 180;
            const v = vertical * Math.PI / 180;
            return {
                x: r * Math.sin(h) * Math.cos(v),
                y: r * Math.sin(v),
                z: -r * Math.cos(h) * Math.cos(v)
            };
        }

        // グリッド生成
        function createGrid() {
            const container = document.getElementById('gridContainer');
            const centerIndex = Math.floor(gridSize / 2);
            let number = 1;

            for (let row = 0; row < gridSize; row++) {
                for (let col = 0; col < gridSize; col++) {
                    const horizontalAngle = (col - centerIndex) * angleStep;
                    const verticalAngle = (centerIndex - row) * angleStep;
                    const pos = sphericalToCartesian(horizontalAngle, verticalAngle, distance);
                    
                    const numberEntity = document.createElement('a-text');
                    numberEntity.setAttribute('value', number.toString());
                    // 垂直位置を調整：カメラの高さ(1.6m)を基準に、全体を少し上げて見やすく
                    numberEntity.setAttribute('position', `${pos.x} ${pos.y + 1.9} ${pos.z}`);
                    numberEntity.setAttribute('align', 'center');
                    numberEntity.setAttribute('color', normalColor);
                    numberEntity.setAttribute('width', '3');
                    numberEntity.setAttribute('look-at', '#camera');
                    numberEntity.setAttribute('visible', 'true'); // 常時表示
                    
                    // 位置情報を保存
                    numberEntity.dataset.number = number;
                    numberEntity.dataset.row = row;
                    numberEntity.dataset.col = col;
                    numberEntity.dataset.horizontalAngle = horizontalAngle;
                    numberEntity.dataset.verticalAngle = verticalAngle;
                    
                    container.appendChild(numberEntity);
                    numberEntities[number] = numberEntity;
                    number++;
                }
            }
            
            console.log('5×5グリッド(1-25)を生成しました');
        }

        // 検査開始
        function startTest() {
            if (testRunning) return; // 既に実行中なら何もしない
            
            testRunning = true;
            currentTrial = 0;
            results = [];
            
            // ランダムな順序で試行リストを作成
            trialSequence = Array.from({length: 25}, (_, i) => i + 1);
            shuffleArray(trialSequence);
            
            document.getElementById('instruction').setAttribute('value', '中心の赤い点を見続けてください');
            
            // 最初の試行を開始
            setTimeout(nextTrial, 2000);
        }

        // 次の試行
        function nextTrial() {
            if (!testRunning || currentTrial >= trialSequence.length) {
                finishTest();
                return;
            }
            
            currentTarget = trialSequence[currentTrial];
            trialStartTime = Date.now();
            waitingForResponse = false;
            
            // 色を緑に変更
            numberEntities[currentTarget].setAttribute('color', targetColor);
            
            // 一定時間後に白に戻す
            setTimeout(() => {
                numberEntities[currentTarget].setAttribute('color', normalColor);
                waitingForResponse = true;
                
                // タイムアウト処理（応答がない場合）
                setTimeout(() => {
                    if (waitingForResponse) {
                        recordResponse('timeout');
                    }
                }, 3000);
            }, stimulusDuration);
            
            updateProgress();
        }

        // 応答記録
        function recordResponse(response) {
            if (!waitingForResponse) return;
            
            waitingForResponse = false;
            const reactionTime = Date.now() - trialStartTime - stimulusDuration;
            
            const target = currentTarget;
            const entity = numberEntities[target];
            
            results.push({
                trial: currentTrial + 1,
                target: target,
                row: parseInt(entity.dataset.row),
                col: parseInt(entity.dataset.col),
                horizontalAngle: parseFloat(entity.dataset.horizontalAngle),
                verticalAngle: parseFloat(entity.dataset.verticalAngle),
                response: response, // 'detected'(検出), 'missed'(見落とし), 'timeout'(無応答)
                reactionTime: reactionTime,
                timestamp: new Date().toISOString()
            });
            
            currentTrial++;
            updateProgress();
            
            // 次の試行へ
            setTimeout(nextTrial, interStimulusInterval);
        }

        // 進捗更新（将来的な拡張用に残す）
        function updateProgress() {
            // VR内では表示しないが、PC版では使用可能
        }

        // 検査終了
        function finishTest() {
            testRunning = false;
            document.getElementById('instruction').setAttribute('value', '');
            
            // 結果計算
            const correct = results.filter(r => r.response === 'detected').length;
            const missed = results.filter(r => r.response === 'missed').length;
            const timeout = results.filter(r => r.response === 'timeout').length;
            const accuracy = (correct / results.length * 100).toFixed(1);
            
            // 左右視野分析
            const leftResults = results.filter(r => r.col < 2);
            const rightResults = results.filter(r => r.col > 2);
            const leftAccuracy = leftResults.length > 0 ? (leftResults.filter(r => r.response === 'detected').length / leftResults.length * 100).toFixed(1) : 0;
            const rightAccuracy = rightResults.length > 0 ? (rightResults.filter(r => r.response === 'detected').length / rightResults.length * 100).toFixed(1) : 0;
            
            // VRメニューを表示して結果を表示
            const uiPanel = document.getElementById('ui-panel-vr');
            uiPanel.setAttribute('visible', 'true');
            
            document.getElementById('result-summary-vr').setAttribute('value', 
                `正答率: ${accuracy}%  (検出: ${correct} / 見落とし: ${missed} / 無応答: ${timeout})`);
            document.getElementById('result-details-vr').setAttribute('value', 
                `左視野: ${leftAccuracy}%  |  右視野: ${rightAccuracy}%`);
            
            displayResults();
        }

        // 結果表示
        function displayResults() {
            const resultsDiv = document.getElementById('results');
            if (!resultsDiv) return; // VRモードでは存在しない場合がある
            
            const correct = results.filter(r => r.response === 'detected').length;
            const missed = results.filter(r => r.response === 'missed').length;
            const timeout = results.filter(r => r.response === 'timeout').length;
            const accuracy = (correct / results.length * 100).toFixed(1);
            
            // 左右視野分析
            const leftResults = results.filter(r => r.col < 2);
            const rightResults = results.filter(r => r.col > 2);
            const leftAccuracy = (leftResults.filter(r => r.response === 'detected').length / leftResults.length * 100).toFixed(1);
            const rightAccuracy = (rightResults.filter(r => r.response === 'detected').length / rightResults.length * 100).toFixed(1);
            
            let html = `
                <h4>検査結果</h4>
                <div class="result-good">検出: ${correct}</div>
                <div class="result-bad">見落とし: ${missed}</div>
                <div>無応答: ${timeout}</div>
                <div><strong>正答率: ${accuracy}%</strong></div>
                <hr>
                <div>左視野: ${leftAccuracy}%</div>
                <div>右視野: ${rightAccuracy}%</div>
                <hr>
                <h4>ヒートマップ</h4>
                <div class="heatmap">
            `;
            
            // ヒートマップ生成
            for (let i = 1; i <= 25; i++) {
                const result = results.find(r => r.target === i);
                let bgColor = '#333';
                if (result) {
                    if (result.response === 'detected') bgColor = '#4CAF50';
                    else if (result.response === 'missed') bgColor = '#f44336';
                    else bgColor = '#FF9800';
                }
                html += `<div class="heatmap-cell" style="background-color: ${bgColor}">${i}</div>`;
            }
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        // リセット
        function resetTest() {
            testRunning = false;
            currentTrial = 0;
            results = [];
            waitingForResponse = false;
            
            // VRメニューを非表示
            document.getElementById('ui-panel-vr').setAttribute('visible', 'false');
            
            document.getElementById('instruction').setAttribute('value', 
                '右トリガーを押すと検査開始\n\n緑色に変わった数字があったら右トリガー\n何も変わらなかったら左トリガー');
            
            // すべての数字を白色に戻す
            Object.values(numberEntities).forEach(entity => {
                entity.setAttribute('color', normalColor);
            });
        }

        // 結果エクスポート
        function exportResults() {
            const csv = generateCSV();
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `VVFT_results_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('結果をエクスポートしました');
        }

        // CSV生成
        function generateCSV() {
            let csv = 'Trial,Target,Row,Col,HorizontalAngle,VerticalAngle,Response,ReactionTime,Timestamp\n';
            results.forEach(r => {
                csv += `${r.trial},${r.target},${r.row},${r.col},${r.horizontalAngle},${r.verticalAngle},${r.response},${r.reactionTime},${r.timestamp}\n`;
            });
            return csv;
        }

        // 配列シャッフル
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // コントローラー入力処理
        window.addEventListener('load', function() {
            createGrid();
            
            const rightController = document.getElementById('rightController');
            const leftController = document.getElementById('leftController');
            
            // 右トリガー: 待機中なら検査開始、検査中なら「色変化を検出」
            rightController.addEventListener('triggerdown', function() {
                if (!testRunning && !waitingForResponse) {
                    // 待機中なら検査開始
                    startTest();
                } else if (testRunning && waitingForResponse) {
                    // 検査中なら「色変化を検出した」
                    recordResponse('detected');
                }
            });
            
            // 左トリガー: 検査中なら「色変化を見落とした」
            leftController.addEventListener('triggerdown', function() {
                if (testRunning && waitingForResponse) {
                    recordResponse('missed');
                }
            });
            
            // VRボタンのクリック処理
            document.getElementById('resetBtn-vr').addEventListener('click', function() {
                resetTest();
            });
            
            // キーボード対応(デバッグ用)
            document.addEventListener('keydown', function(e) {
                if (!testRunning && !waitingForResponse && e.key === ' ') {
                    // スペースキーで検査開始
                    startTest();
                } else if (testRunning && waitingForResponse) {
                    if (e.key === 'ArrowRight' || e.key === 's') {
                        recordResponse('detected');
                    } else if (e.key === 'ArrowLeft' || e.key === 'n') {
                        recordResponse('missed');
                    }
                }
            });
        });
    </script>
</body>
</html>
